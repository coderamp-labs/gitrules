<!-- Right Panel: Quick Actions with Dynamic Theme -->
<div class="workspace-actions qa-sidebar-section relative overflow-hidden" data-qa-theme="yellow">
    <!-- Background Layer -->
    <div class="qa-sidebar-bg absolute inset-0 transition-colors duration-300"></div>
    
    <!-- Content Container -->
    <div class="relative z-10 p-4">
        <h3 class="text-lg font-black text-black mb-3">Quick Actions</h3>
        
        <!-- Joined Tabs and Card Container -->
        <div class="qa-tabs-card-container">
            <!-- Tabs Header -->
            <div class="flex gap-1 relative" role="tablist">
                <button 
                    role="tab"
                    aria-selected="true"
                    data-tab="mcps"
                    data-theme="yellow"
                    onclick="switchQuickActionTab('mcps', 'yellow')" 
                    id="qa-tab-mcps" 
                    class="qa-sidebar-tab active px-3 py-2 bg-white border-2 border-black font-bold text-xs transition-all relative z-20 shadow-[3px_3px_0px_0px_rgba(0,0,0,1)] hover:shadow-[4px_4px_0px_0px_rgba(0,0,0,1)] hover:translate-x-[-1px] hover:translate-y-[-1px] active:shadow-[1px_1px_0px_0px_rgba(0,0,0,1)] active:translate-x-[1px] active:translate-y-[1px]"
                >
                    MCPs
                </button>
                <button 
                    role="tab"
                    aria-selected="false"
                    data-tab="rules"
                    data-theme="pink"
                    onclick="switchQuickActionTab('rules', 'pink')" 
                    id="qa-tab-rules" 
                    class="qa-sidebar-tab px-3 py-2 bg-gray-100 border-2 border-gray-400 font-bold text-xs text-gray-700 transition-all relative z-10 shadow-[2px_2px_0px_0px_rgba(0,0,0,0.3)] hover:shadow-[3px_3px_0px_0px_rgba(0,0,0,0.3)] hover:translate-x-[-1px] hover:translate-y-[-1px] active:shadow-[1px_1px_0px_0px_rgba(0,0,0,0.3)] active:translate-x-[1px] active:translate-y-[1px]"
                >
                    Rules
                </button>
                <button 
                    role="tab"
                    aria-selected="false"
                    data-tab="subagents"
                    data-theme="blue"
                    onclick="switchQuickActionTab('subagents', 'blue')" 
                    id="qa-tab-subagents" 
                    class="qa-sidebar-tab px-3 py-2 bg-gray-100 border-2 border-gray-400 font-bold text-xs text-gray-700 transition-all relative z-10 shadow-[2px_2px_0px_0px_rgba(0,0,0,0.3)] hover:shadow-[3px_3px_0px_0px_rgba(0,0,0,0.3)] hover:translate-x-[-1px] hover:translate-y-[-1px] active:shadow-[1px_1px_0px_0px_rgba(0,0,0,0.3)] active:translate-x-[1px] active:translate-y-[1px]"
                >
                    Subagents
                </button>
            </div>
            
            <!-- White Card Container (visually joined to tabs) -->
            <div class="qa-sidebar-card bg-white border-2 border-black shadow-[2px_2px_0px_0px_rgba(0,0,0,1)] p-3 relative z-30 -mt-1">
                <!-- MCPs Tab Content -->
                <div id="qa-content-mcps" class="qa-tab-content" role="tabpanel">
                    <div id="sidebar-mcps-container" class="space-y-2">
                        <div class="text-xs text-gray-500">Loading...</div>
                    </div>
                </div>

                <!-- Rules Tab Content -->
                <div id="qa-content-rules" class="qa-tab-content hidden" role="tabpanel">
                    <div id="sidebar-rules-container" class="space-y-2">
                        <div class="text-xs text-gray-500">Loading...</div>
                    </div>
                </div>

                <!-- Subagents Tab Content -->
                <div id="qa-content-subagents" class="qa-tab-content hidden" role="tabpanel">
                    <div id="sidebar-agents-container" class="space-y-2">
                        <div class="text-xs text-gray-500">Loading...</div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Theme-specific CSS for Sidebar -->
<style>
/* CSS Variables for Sidebar Theming */
.qa-sidebar-section {
    --qa-sidebar-card-bg: #ffffff;
    --qa-sidebar-card-border: #000000;
    --qa-sidebar-shadow: rgba(0, 0, 0, 1);
    --tab-anim-dur: 150ms;
    --tab-anim-ease: ease;
}

/* Yellow Theme (MCPs) */
.qa-sidebar-section[data-qa-theme="yellow"] {
    --qa-sidebar-accent: #FDE047;
    --qa-sidebar-accent-hover: #FACC15;
    --qa-sidebar-contrast: #000000;
    --qa-sidebar-bg: #FEFCE8;
}

/* Pink Theme (Rules) */
.qa-sidebar-section[data-qa-theme="pink"] {
    --qa-sidebar-accent: #F472B6;
    --qa-sidebar-accent-hover: #EC4899;
    --qa-sidebar-contrast: #000000;
    --qa-sidebar-bg: #FCE7F3;
}

/* Blue Theme (Subagents) */
.qa-sidebar-section[data-qa-theme="blue"] {
    --qa-sidebar-accent: #22D3EE;
    --qa-sidebar-accent-hover: #0EA5E9;
    --qa-sidebar-contrast: #000000;
    --qa-sidebar-bg: #ECFEFF;
}

/* Background Layer */
.qa-sidebar-bg {
    background-color: var(--qa-sidebar-bg);
    transition: background-color var(--tab-anim-dur) var(--tab-anim-ease);
}

/* Joined Card and Tabs Container */
.qa-tabs-card-container {
    position: relative;
}

/* Card properly positioned */
.qa-sidebar-card {
    position: relative;
}

/* Active tab gets accent color */
.qa-sidebar-tab.active {
    background-color: var(--qa-sidebar-accent) !important;
    border-color: black !important;
    color: black !important;
    position: relative;
}


/* Inactive tabs */
.qa-sidebar-tab:not(.active) {
    background-color: #f3f4f6;
    border-color: #9ca3af;
    color: #6b7280;
}

/* Themed Buttons */
.qa-sidebar-section .qa-sidebar-card .sidebar-themed-button {
    background-color: white;
    border: 2px solid black;
    color: black;
    font-weight: bold;
    padding: 0.5rem 0.75rem;
    display: flex;
    align-items: center;
    gap: 0.5rem;
    box-shadow: 2px 2px 0px 0px rgba(0,0,0,1);
    transition: all 150ms;
    width: 100%;
    text-align: left;
    font-size: 0.75rem;
}

.qa-sidebar-section .qa-sidebar-card .sidebar-themed-button:hover {
    box-shadow: 3px 3px 0px 0px rgba(0,0,0,1);
    transform: translate(-1px, -1px);
}

.qa-sidebar-section .qa-sidebar-card .sidebar-themed-button:active {
    box-shadow: 1px 1px 0px 0px rgba(0,0,0,1);
    transform: translate(1px, 1px);
}

.qa-sidebar-section .qa-sidebar-card .sidebar-themed-button .button-accent-icon {
    background-color: var(--qa-sidebar-accent);
    color: var(--qa-sidebar-contrast);
    width: 20px;
    height: 20px;
    display: flex;
    align-items: center;
    justify-content: center;
    font-weight: bold;
    font-size: 0.75rem;
    border: 1px solid black;
}
</style>

<script>
// Current sidebar tab state
let currentSidebarTab = 'mcps';
let currentSidebarTheme = 'yellow';

function switchQuickActionTab(tabName, theme) {
    // Update current state
    currentSidebarTab = tabName;
    currentSidebarTheme = theme;
    
    // Update section theme
    const section = document.querySelector('.qa-sidebar-section');
    if (section) {
        section.setAttribute('data-qa-theme', theme);
    }
    
    // Update all tabs - active gets theme color, inactive gets gray
    document.querySelectorAll('.qa-sidebar-tab').forEach(tab => {
        if (tab.dataset.tab === tabName) {
            // Active tab styling - note: bg color handled by CSS variable
            tab.className = 'qa-sidebar-tab active px-3 py-2 border-2 border-black font-bold text-xs transition-all relative z-20 shadow-[3px_3px_0px_0px_rgba(0,0,0,1)] hover:shadow-[4px_4px_0px_0px_rgba(0,0,0,1)] hover:translate-x-[-1px] hover:translate-y-[-1px] active:shadow-[1px_1px_0px_0px_rgba(0,0,0,1)] active:translate-x-[1px] active:translate-y-[1px]';
            tab.setAttribute('aria-selected', 'true');
        } else {
            // Inactive tab styling
            tab.className = 'qa-sidebar-tab px-3 py-2 bg-gray-100 border-2 border-gray-400 font-bold text-xs text-gray-700 transition-all relative z-10 shadow-[2px_2px_0px_0px_rgba(0,0,0,0.3)] hover:shadow-[3px_3px_0px_0px_rgba(0,0,0,0.3)] hover:translate-x-[-1px] hover:translate-y-[-1px] active:shadow-[1px_1px_0px_0px_rgba(0,0,0,0.3)] active:translate-x-[1px] active:translate-y-[1px]';
            tab.setAttribute('aria-selected', 'false');
        }
    });
    
    // Update panels
    document.querySelectorAll('.qa-tab-content').forEach(panel => {
        if (panel.id === `qa-content-${tabName}`) {
            panel.classList.remove('hidden');
        } else {
            panel.classList.add('hidden');
        }
    });
}

// Workspace sidebar action function - just inserts text, doesn't create contexts
function insertTextAction(text) {
    if (window.insertTextAtCursor) {
        window.insertTextAtCursor(text);
    } else {
        console.error('insertTextAtCursor function not available');
    }
}

// Cache for sidebar actions data
let sidebarActionsCache = null;

// Load sidebar actions from backend
async function loadSidebarActions() {
    try {
        // Use cached data if available
        if (sidebarActionsCache) {
            renderSidebarActions(sidebarActionsCache);
            return;
        }
        
        const response = await fetch('/api/actions/');
        if (!response.ok) throw new Error('Failed to fetch actions');
        
        const data = await response.json();
        
        // Cache the data
        sidebarActionsCache = data;
        
        renderSidebarActions(data);
    } catch (error) {
        console.error('Error loading sidebar actions:', error);
    }
}

// Render sidebar actions from data
function renderSidebarActions(data) {
    try {
        
        // Render MCPs
        const mcpsContainer = document.getElementById('sidebar-mcps-container');
        if (mcpsContainer && data.mcps) {
            mcpsContainer.innerHTML = data.mcps.map(mcp => {
                const name = mcp.name || 'Unknown';
                return `
                <button class="sidebar-themed-button" onclick="installMCP('${name.replace(/'/g, "\\'")}')">
                    <span class="button-accent-icon">+</span>
                    <span>${name}</span>
                </button>
            `}).join('');
        }
        
        // Render rules
        const rulesContainer = document.getElementById('sidebar-rules-container');
        if (rulesContainer && data.rules) {
            rulesContainer.innerHTML = data.rules.map(rule => {
                const name = rule.name || 'Unknown';
                return `
                <button class="sidebar-themed-button" onclick="installRule('${name.replace(/'/g, "\\'")}')">
                    <span class="button-accent-icon">+</span>
                    <span>${name}</span>
                </button>
            `}).join('');
        }
        
        // Render agents
        const agentsContainer = document.getElementById('sidebar-agents-container');
        if (agentsContainer && data.agents) {
            agentsContainer.innerHTML = data.agents.map(agent => {
                const name = agent.name || 'Unknown';
                return `
                <button class="sidebar-themed-button" onclick="installAgent('${name.replace(/'/g, "\\'")}')">
                    <span class="button-accent-icon">+</span>
                    <span>${name}</span>
                </button>
            `}).join('');
        }
    } catch (error) {
        console.error('Error loading sidebar actions:', error);
    }
}

// Install functions
async function installAgent(agentName) {
    if (!agentName || agentName === 'Unknown') {
        console.error('Invalid agent name');
        return;
    }
    try {
        const response = await fetch(`/api/actions/agent-content/${encodeURIComponent(agentName)}`);
        
        if (response.ok) {
            const result = await response.json();
            
            // Add to virtual workspace
            if (window.workspaceManager && window.workspaceManager.currentState) {
                window.workspaceManager.currentState.addFile(result.path, result.content);
                window.workspaceManager.saveState(window.workspaceManager.currentContextId);
                window.workspaceManager.render();
            }
        } else {
            const error = await response.json();
            alert(`❌ Error: ${error.detail}`);
        }
    } catch (error) {
        alert(`❌ Error installing agent: ${error.message}`);
    }
}

async function installMCP(mcpName) {
    if (!mcpName || mcpName === 'Unknown') {
        console.error('Invalid MCP name');
        return;
    }
    try {
        // Get current .mcp.json content from workspace
        let currentConfig = {};
        if (window.workspaceManager && window.workspaceManager.getState()) {
            const mcpFile = window.workspaceManager.getState().files['.mcp.json'];
            if (mcpFile) {
                try {
                    currentConfig = JSON.parse(mcpFile);
                } catch (e) {
                    currentConfig = {};
                }
            }
        }
        
        const response = await fetch(`/api/actions/mcp-config/${encodeURIComponent(mcpName)}`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify(currentConfig)
        });
        
        if (response.ok) {
            const result = await response.json();
            
            // Add to virtual workspace
            if (window.workspaceManager && window.workspaceManager.currentState) {
                window.workspaceManager.currentState.addFile(result.path, result.content);
                window.workspaceManager.saveState(window.workspaceManager.currentContextId);
                window.workspaceManager.render();
            }
        } else {
            const error = await response.json();
            alert(`❌ Error: ${error.detail}`);
        }
    } catch (error) {
        alert(`❌ Error installing MCP: ${error.message}`);
    }
}

async function installRule(ruleName) {
    if (!ruleName || ruleName === 'Unknown') {
        console.error('Invalid rule name');
        return;
    }
    try {
        const response = await fetch(`/api/actions/rule-content/${encodeURIComponent(ruleName)}`);
        
        if (response.ok) {
            const result = await response.json();
            
            // Get current CLAUDE.md content from workspace
            let currentContent = '';
            if (window.workspaceManager && window.workspaceManager.getState()) {
                const claudeFile = window.workspaceManager.getState().files['CLAUDE.md'];
                if (claudeFile) {
                    currentContent = claudeFile;
                }
            }
            
            // Toggle behavior: if rule already exists, remove it; if not, add it
            const ruleContent = result.content.trim();
            let newContent;
            
            if (currentContent.includes(ruleContent)) {
                // Remove the rule
                newContent = currentContent
                    .split('\n')
                    .filter(line => line.trim() !== ruleContent)
                    .join('\n')
                    .replace(/\n\n+/g, '\n\n') // Clean up multiple newlines
                    .trim();
            } else {
                // Add the rule
                newContent = currentContent + (currentContent ? '\n' : '') + ruleContent;
            }
            
            // Add to virtual workspace
            if (window.workspaceManager && window.workspaceManager.currentState) {
                window.workspaceManager.currentState.addFile('CLAUDE.md', newContent);
                window.workspaceManager.saveState(window.workspaceManager.currentContextId);
                window.workspaceManager.render();
            }
        } else {
            const error = await response.json();
            alert(`❌ Error: ${error.detail}`);
        }
    } catch (error) {
        alert(`❌ Error installing rule: ${error.message}`);
    }
}

// Load actions when DOM is ready
document.addEventListener('DOMContentLoaded', function() {
    loadSidebarActions();
});
</script>